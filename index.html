<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>CODM - ××—×©×‘×•×Ÿ ×©×•×•×™ ×—×©×‘×•×Ÿ</title>
    <style>
        /* RESET + BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: #0a0c0f;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }

        /* ×§×•× ×˜×™×™× ×¨ ×¨××©×™ â€“ ×’×™×™××™× ×’ ××¤×œ ×¢× ×–×•×”×¨ LED */
        .game-container {
            max-width: 500px;
            width: 100%;
            background: linear-gradient(145deg, #111316 0%, #0b0d10 100%);
            border-radius: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8), 0 0 0 2px rgba(0, 255, 255, 0.15), 0 0 20px #00ffff33;
            padding: 24px 20px;
            border: 1px solid #00ffff22;
            position: relative;
            overflow: hidden;
        }

        /* ××¤×§×˜ LED ×–×•×”×¨ ×¢×“×™×Ÿ ××¡×‘×™×‘ */
        .game-container::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00ffff, #aa00ff, #00ffff);
            border-radius: 42px;
            z-index: -2;
            opacity: 0.3;
            filter: blur(8px);
        }

        /* HEADER - ×¡×›×•× ×—×™ ×™×¨×•×§ + ×× ×™××¦×™×” */
        .balance-header {
            background: rgba(0, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid #00ffff40;
            border-radius: 60px;
            padding: 18px 22px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px #00ffff20, inset 0 0 10px #00ffff10;
            text-align: center;
        }

        .balance-label {
            font-size: 14px;
            letter-spacing: 1px;
            color: #a0e0ff;
            text-shadow: 0 0 6px cyan;
            margin-bottom: 6px;
        }

        .balance-value {
            font-size: 48px;
            font-weight: 800;
            color: #3eff9e;
            text-shadow: 0 0 20px #00ff80, 0 0 40px #00ff8040;
            line-height: 1.1;
            direction: ltr;
            display: inline-block;
            font-feature-settings: "tnum";
            transition: all 0.1s ease;
            position: relative;
        }

        /* ×× ×™××¦×™×™×ª ×§×¤×™×¦×” ×§×˜× ×” ×œ×¡×¤×¨×•×ª */
        .balance-value span {
            display: inline-block;
            animation: digitPop 0.3s ease-out;
        }

        @keyframes digitPop {
            0% { transform: translateY(0); opacity: 0.8; }
            50% { transform: translateY(-8px); opacity: 1; text-shadow: 0 0 40px #00ff80; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .shekel-sign {
            font-size: 32px;
            margin-right: 5px;
            color: #9effb0;
        }

        /* ×©××œ×” ×›×•×ª×¨×ª */
        .question-title {
            font-size: 22px;
            font-weight: 600;
            color: #eef5ff;
            text-shadow: 0 0 10px cyan;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .question-title .tooltip-btn {
            background: none;
            border: none;
            color: #0ff;
            font-size: 18px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #00ffff20;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .question-title .tooltip-btn:hover {
            background: #00ffff60;
            box-shadow: 0 0 15px cyan;
        }

        /* ×›×¤×ª×•×¨×™× ×’×“×•×œ×™× (×‘×—×™×¨×”) */
        .choice-row {
            display: flex;
            gap: 15px;
            margin: 20px 0 15px;
        }

        .choice-btn {
            flex: 1;
            background: #1e1e2a;
            border: 2px solid #334455;
            border-radius: 40px;
            padding: 20px 0;
            font-size: 24px;
            font-weight: 700;
            color: #ccddee;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 0 #0a0c0f;
            text-align: center;
        }

        .choice-btn.active {
            border-color: #0ff;
            background: #0a1a1f;
            color: #0ff;
            box-shadow: 0 0 30px #00ffff60, 0 5px 0 #008888;
            transform: translateY(-2px);
        }

        /* ×§×™×©×•×¨ ×œ×—×™×¦××™ (×¤×•×ª×— ××•×“×œ) */
        .info-link {
            color: #0ff;
            font-size: 15px;
            text-decoration: none;
            border-bottom: 1px dashed cyan;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 25px;
        }

        /* ×¡×œ×™×™×“×¨ + ××¡×¤×¨ + ×ª×•×•×™×ª */
        .slider-block {
            margin: 30px 0;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            color: #b0d0ff;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .number-display {
            font-size: 42px;
            font-weight: 800;
            direction: ltr;
            display: inline-block;
            background: #00000040;
            padding: 0 20px 0 10px;
            border-radius: 30px;
            border: 1px solid cyan;
            box-shadow: 0 0 15px cyan;
            margin-bottom: 15px;
        }

        .number-display input {
            background: transparent;
            border: none;
            color: #0ff;
            font-size: 42px;
            font-weight: 800;
            width: 100px;
            text-align: center;
            outline: none;
            direction: ltr;
        }

        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            opacity: 1;
            height: 30px;
        }

        .slider-container {
            width: 100%;
            margin: 10px 0 5px;
            position: relative;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, #00ffff, #aa00ff);
            border-radius: 10px;
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 20px cyan;
            border: 2px solid cyan;
            cursor: pointer;
            margin-top: -7px;
        }

        .limit-indicator {
            font-size: 14px;
            color: #b0f0ff;
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #2a2a3a;
            border-radius: 10px;
            margin: 15px 0 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ff, #f0f);
            width: 0%;
            border-radius: 10px;
            box-shadow: 0 0 15px #0ff;
        }

        .fraction-text {
            color: #0ff;
            font-weight: 600;
        }

        /* ×¦×‘×¢×™ ×§×˜×’×•×¨×™×•×ª */
        .mythic-color {
            color: #ff4d4d !important;
            text-shadow: 0 0 10px red;
        }
        .legendary-color {
            color: #ffb347 !important;
            text-shadow: 0 0 10px orange;
        }
        .epic-color {
            color: #c77dff !important;
            text-shadow: 0 0 10px #b266ff;
        }

        /* ×›×¤×ª×•×¨×™ ×“×™×¨×•×’ */
        .rank-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .rank-tab {
            background: #1e1e30;
            border: 1px solid #0ff;
            border-radius: 30px;
            padding: 10px 18px;
            font-size: 16px;
            color: #0ff;
            cursor: pointer;
            transition: 0.2s;
            flex: 1 0 auto;
        }

        .rank-tab.active {
            background: #0ff;
            color: #0a0c0f;
            font-weight: 700;
            box-shadow: 0 0 30px cyan;
        }

        .rank-panel {
            background: #151520;
            border-radius: 30px;
            padding: 15px;
            margin: 10px 0;
        }

        .rank-panel .slider-header span {
            font-size: 28px;
        }

        .pro { color: #0ff; }
        .master { color: #b266ff; }
        .grandmaster { color: #ffa64d; }
        .legendary { color: #ff3333; }

        /* ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin: 35px 0 15px;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid cyan;
            color: cyan;
            font-size: 20px;
            padding: 14px 30px;
            border-radius: 60px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 0 15px cyan;
        }

        .nav-btn:disabled {
            opacity: 0.3;
            filter: grayscale(1);
            pointer-events: none;
        }

        /* ××•×“×œ (×—×œ×•×Ÿ ×§×•×¤×¥) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #11161f;
            border: 2px solid cyan;
            border-radius: 40px;
            padding: 30px 25px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 100px #0ff;
            position: relative;
            color: white;
        }

        .close-modal {
            position: absolute;
            left: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: cyan;
        }

        /* ×¢××•×“ ×¡×™×›×•× */
        .summary-page {
            text-align: center;
        }
        .final-value-box {
            background: #1a1a2a;
            border-radius: 60px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #ff4d4d;
        }
        .final-value {
            font-size: 72px;
            font-weight: 900;
            color: #ff4d4d;
            text-shadow: 0 0 40px red;
            direction: ltr;
        }
        .original-value {
            font-size: 28px;
            color: #a0ffc0;
            text-decoration: line-through #ff8888 3px;
            margin-bottom: 15px;
        }

        /* ×”×ª×—×œ×” */
        .welcome-screen {
            text-align: center;
            padding: 20px 0;
        }
        .big-start-btn {
            background: cyan;
            border: none;
            font-size: 32px;
            font-weight: 800;
            color: black;
            padding: 25px 40px;
            border-radius: 80px;
            margin: 30px 0;
            box-shadow: 0 0 70px cyan;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="game-container" id="gameContainer">

    <!-- ××•×“×œ ××™×“×¢ ×›×œ×œ×™ -->
    <div id="infoModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modalText" style="font-size:18px; line-height:1.6;">××™×“×¢</div>
        </div>
    </div>

    <!-- ××¡×š ×¤×ª×™×— -->
    <div id="welcomeScreen">
        <div class="welcome-screen">
            <div class="question-title" style="justify-content: center;">ğŸ® CODM VALUE</div>
            <div style="color:#b0f0ff; margin:20px 0;">×‘×¨×•×›×™× ×”×‘××™× ×œ××—×©×‘×•×Ÿ ×©×•×•×™ ×”×—×©×‘×•×Ÿ ×”××ª×§×“×</div>
            <button class="big-start-btn" onclick="startCalculator()">×”×ª×—×œ ×—×™×©×•×‘</button>
            <div style="margin-top:30px; color: cyan; opacity:0.6;">âš¡ ××•×¤×¢×œ ×¢"×™ LEDè¾¹ç¼˜</div>
        </div>
    </div>

    <!-- ××¡×š ×—×™×©×•×‘ ×¨××©×™ (××•×¡×ª×¨ ×‘×”×ª×—×œ×”) -->
    <div id="calculatorScreen" class="hidden">
        <!-- ×¡×›×•× ×—×™ ×ª××™×“×™ -->
        <div class="balance-header">
            <div class="balance-label">×©×•×•×™ × ×•×›×—×™</div>
            <div class="balance-value" id="liveBalance">0.00 â‚ª</div>
        </div>

        <!-- ××–×•×¨ ×ª×•×›×Ÿ ××©×ª× ×” ×©×œ×‘ -->
        <div id="stepContainer"></div>

        <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ -->
        <div class="nav-buttons">
            <button class="nav-btn" id="prevBtn" onclick="prevStep()" disabled>â¬… ×”×§×•×“×</button>
            <button class="nav-btn" id="nextBtn" onclick="nextStep()">×”×‘× â”</button>
        </div>
    </div>

    <!-- ×–×›×¨×•×Ÿ: ×”×•×“×¢×” ×œ×—×©×‘×•×Ÿ ×§×™×™× -->
    <div id="memoryToast" style="display:none; background:#00ff8040; border-radius: 30px; padding: 10px; margin-bottom: 10px; color: white; text-align: center;">
        âš¡ ×—×™×©×•×‘ ×§×•×“× × ×˜×¢×Ÿ. <button onclick="resetToWelcome()" style="background:cyan; border:none; border-radius:30px; padding:5px 15px;">×—×“×©</button>
    </div>
</div>

<script>
    (function() {
        // ---------- TODO: ×›×œ ×¢×¨×›×™ ×‘×¨×™×¨×ª ×”××—×“×œ ×•×”×—×™×©×•×‘ - ×©× ×” ×¤×” ×‘×§×œ×•×ª ----------
        const BASE_VALUES = {
            discounted: {  // ×—×©×‘×•×Ÿ ××•×–×œ
                year: 40,
                weaponMythic: 210,
                weaponLegendary: 160,
                weaponEpic: 1,
                weaponMythicMax: 89,
                characterMythic: 250,
                characterMythicMax: 110,
                characterLegendary: 170,
                characterEpic: 1,
                characterRare: 80,
                level: 0.5,
                rank: 1
            },
            regular: {  // ×—×©×‘×•×Ÿ ×¨×’×™×œ (×œ× ××•×–×œ)
                year: 40,
                weaponMythic: 420,
                weaponLegendary: 350,
                weaponEpic: 2,
                weaponMythicMax: 380,
                characterMythic: 450,
                characterMythicMax: 350,
                characterLegendary: 400,
                characterEpic: 1,
                characterRare: 120,
                level: 0.5,
                rank: 1
            }
        };

        // ××’×‘×œ×•×ª: ×”×¢×¨×” ×œ×©× ×•×ª ×›××Ÿ
        const LIMITS = {
            years: 9,
            mythicWeapons: 32,
            mythicWeaponsMax: 32,
            legWeapons: 255,
            epicWeapons: 991,
            mythicChars: 7,
            mythicCharsMax: 7,
            legChars: 28,
            epicChars: 1000,
            rareChars: 100,
            level: 400,
            // ×“×™×¨×•×’: 0-? × ×©×ª××© ×‘××‘× ×”
        };
        // ---------- ×¡×•×£ ××–×•×¨ ×¢×¨×™×›×” ×§×œ×” ----------

        // State
        let stepIndex = 0;
        const steps = [
            'accountType', 'years', 'mythicWeapons', 'mythicWeaponsMax', 'legWeapons', 'epicWeapons',
            'mythicChars', 'mythicCharsMax', 'legChars', 'epicChars', 'rareCharExist', 'rareCharAmount',
            'level', 'ranks'
        ];
        let accountData = {
            discounted: true, // true = ××•×–×œ, false = ×¨×’×™×œ
            years: 0,
            mythicWeapons: 0,
            mythicWeaponsMax: 0,
            legWeapons: 0,
            epicWeapons: 0,
            mythicChars: 0,
            mythicCharsMax: 0,
            legChars: 0,
            epicChars: 0,
            rareCharExist: false,
            rareCharAmount: 0,
            level: 0,
            rankMP: 0,
            rankBR: 0,
            rankDMZ: 0,
        };

        // ×©××™×¨×” ×‘-localStorage (×œ×œ× ×ª×¤×•×’×”)
        const STORAGE_KEY = 'codmCalculatorState';
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({accountData, stepIndex}));
            } catch(e) {}
        }
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if(saved) {
                    const parsed = JSON.parse(saved);
                    if(parsed.accountData) accountData = parsed.accountData;
                    if(parsed.stepIndex !== undefined) stepIndex = parsed.stepIndex;
                    return true;
                }
            } catch(e) {}
            return false;
        }

        // ×× ×™××¦×™×™×ª ×¢×“×›×•×Ÿ ××¡×¤×¨
        let currentDisplayBalance = 0;
        function updateBalanceDisplay(newBalance) {
            const balanceEl = document.getElementById('liveBalance');
            if(!balanceEl) return;
            const oldText = balanceEl.innerText;
            const oldNum = parseFloat(oldText.replace(/[^\d.-]/g, '')) || 0;
            if(Math.abs(newBalance - oldNum) < 0.01) return;
            // ×× ×™××¦×™×™×ª ×¡×¤×¨×•×ª ×¤×©×•×˜×”: × ×§×¤×™×¥ ××ª ×”×¡×¤×¨×•×ª
            balanceEl.innerText = formatMoney(newBalance);
            balanceEl.innerHTML = balanceEl.innerText.split('').map(c => c.match(/[0-9]/) ? `<span>${c}</span>` : c).join('');
        }

        function formatMoney(val) {
            return val.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + ' â‚ª';
        }

        // ×—×™×©×•×‘ ×©×•×•×™ ×›×•×œ×œ ×œ×¤×™ accountData
        function computeTotalValue() {
            const values = accountData.discounted ? BASE_VALUES.discounted : BASE_VALUES.regular;
            let total = 0;
            total += accountData.years * values.year;
            total += accountData.mythicWeapons * values.weaponMythic;
            total += accountData.legWeapons * values.weaponLegendary;
            total += accountData.epicWeapons * values.weaponEpic;
            total += accountData.mythicWeaponsMax * values.weaponMythicMax;
            total += accountData.mythicChars * values.characterMythic;
            total += accountData.mythicCharsMax * values.characterMythicMax;
            total += accountData.legChars * values.characterLegendary;
            total += accountData.epicChars * values.characterEpic;
            total += (accountData.rareCharExist ? accountData.rareCharAmount : 0) * values.characterRare;
            total += accountData.level * values.level;
            total += (accountData.rankMP + accountData.rankBR + accountData.rankDMZ) * values.rank;
            return total;
        }

        function getCurrentStepUI() {
            const step = steps[stepIndex];
            const container = document.getElementById('stepContainer');
            const isDiscounted = accountData.discounted;
            const values = isDiscounted ? BASE_VALUES.discounted : BASE_VALUES.regular;
            // ×‘× ×™×™×ª ×××©×§ ×œ×¤×™ step
            let html = '';
            if(step === 'accountType') {
                html = `
                    <div class="question-title">×‘×—×¨ ×¡×•×’ ×—×©×‘×•×Ÿ</div>
                    <div class="choice-row">
                        <button class="choice-btn ${accountData.discounted===true?'active':''}" onclick="setAccountType(true)">××•×–×œ</button>
                        <button class="choice-btn ${accountData.discounted===false?'active':''}" onclick="setAccountType(false)">×œ× ××•×–×œ</button>
                    </div>
                    <span class="info-link" onclick="openModal('×—×©×‘×•×Ÿ ××•×–×œ ×–×” ×—×©×‘×•×Ÿ ×©× ×¤×ª×— ×‘×”×•×“×• ××• ×‘×™×©×¨××œ ×“×¨×š VPN ×©××—×•×‘×¨ ×œ×”×•×“×•. ×‘×—×©×‘×•×Ÿ ××•×–×œ ×¤×ª×™×—×•×ª ×”×’×¨×œ×•×ª ××ª×—×™×œ×•×ª ×‘-10CP, ×‘×—×©×‘×•×Ÿ ×œ× ××•×–×œ ×‘-30CP.')">ğŸ“Œ ××™×š ×× ×™ ×™×•×“×¢ ××™×–×” ×¡×•×’ ×—×©×‘×•×Ÿ ×™×© ×œ×™?</span>
                `;
            } else if(step === 'years') {
                html = renderSlider('×•×•×ª×§ ×”×—×©×‘×•×Ÿ (×©× ×™×)', 'years', accountData.years, 0, LIMITS.years, '×©× ×™×');
            } else if(step === 'mythicWeapons') {
                html = renderSlider('×›××” × ×©×§×™ ××™×˜×™×§ ×§×™×™××™×?', 'mythicWeapons', accountData.mythicWeapons, 0, LIMITS.mythicWeapons, '× ×©×§×™×', 'mythic');
            } else if(step === 'mythicWeaponsMax') {
                if(accountData.mythicWeapons > 0) 
                    html = renderSlider('××ª×•×›× ×‘×¨××ª ××§×¡×™××•×', 'mythicWeaponsMax', accountData.mythicWeaponsMax, 0, Math.min(accountData.mythicWeapons, LIMITS.mythicWeaponsMax), 'MAX', 'mythic');
                else stepIndex++; return getCurrentStepUI();
            } else if(step === 'legWeapons') {
                html = renderSlider('×›××” × ×©×§×™ ×œ×’×³× ×“×¨×™?', 'legWeapons', accountData.legWeapons, 0, LIMITS.legWeapons, '× ×©×§×™×', 'legendary');
            } else if(step === 'epicWeapons') {
                html = renderSlider('×›××” × ×©×§×™ ××¤×™×§?', 'epicWeapons', accountData.epicWeapons, 0, LIMITS.epicWeapons, '× ×©×§×™×', 'epic');
            } else if(step === 'mythicChars') {
                html = renderSlider('×›××” ×“××•×™×•×ª ××™×˜×™×§?', 'mythicChars', accountData.mythicChars, 0, LIMITS.mythicChars, '×“××•×™×•×ª', 'mythic');
            } else if(step === 'mythicCharsMax') {
                if(accountData.mythicChars > 0) 
                    html = renderSlider('××ª×•×›×Ÿ ×‘×¨××ª ××§×¡×™××•×', 'mythicCharsMax', accountData.mythicCharsMax, 0, Math.min(accountData.mythicChars, LIMITS.mythicCharsMax), 'MAX', 'mythic');
                else stepIndex++; return getCurrentStepUI();
            } else if(step === 'legChars') {
                html = renderSlider('×›××” ×“××•×™×•×ª ×œ×’×³× ×“×¨×™?', 'legChars', accountData.legChars, 0, LIMITS.legChars, '×“××•×™×•×ª', 'legendary');
            } else if(step === 'epicChars') {
                html = renderSlider('×›××” ×“××•×™×•×ª ××¤×™×§?', 'epicChars', accountData.epicChars, 0, LIMITS.epicChars, '×“××•×™×•×ª', 'epic');
            } else if(step === 'rareCharExist') {
                html = `
                    <div class="question-title">×”×× ×§×™×™××•×ª ×“××•×™×•×ª ××’×“×™×•×ª × ×“×™×¨×•×ª?</div>
                    <div class="choice-row">
                        <button class="choice-btn ${accountData.rareCharExist===true?'active':''}" onclick="setRareExist(true)">×›×Ÿ</button>
                        <button class="choice-btn ${accountData.rareCharExist===false?'active':''}" onclick="setRareExist(false)">×œ×</button>
                    </div>
                `;
            } else if(step === 'rareCharAmount') {
                if(accountData.rareCharExist) 
                    html = renderSlider('×›××•×ª ×“××•×™×•×ª ××’×“×™×•×ª × ×“×™×¨×•×ª', 'rareCharAmount', accountData.rareCharAmount, 0, LIMITS.rareChars, '×“××•×™×•×ª', 'legendary');
                else stepIndex++; return getCurrentStepUI();
            } else if(step === 'level') {
                html = renderSlider('×¨××ª ×”×—×©×‘×•×Ÿ (LEVEL)', 'level', accountData.level, 0, LIMITS.level, '×¨××”');
            } else if(step === 'ranks') {
                html = renderRanksUI();
            } else if(step === 'summary') {
                const total = computeTotalValue();
                const finalPrice = accountData.discounted ? total * 0.35 : total * 0.55; // 65% off / 45% off
                html = `
                    <div class="summary-page">
                        <div class="question-title">×¡×™×›×•× ×©×•×•×™</div>
                        <div class="original-value">×”×©×§×¢×”: ${formatMoney(total)}</div>
                        <div class="final-value-box">
                            <div style="font-size:20px; color:cyan;">××—×™×¨ ×œ××›×™×¨×”</div>
                            <div class="final-value" id="finalValue">${formatMoney(finalPrice)}</div>
                        </div>
                        <button class="nav-btn" onclick="saveAndShowHome()">ğŸ’° ×©××•×¨ ×•×—×–×•×¨</button>
                    </div>
                `;
            }
            container.innerHTML = html;
            attachSliderListeners(step);
            updateBalanceDisplay(computeTotalValue());
            document.getElementById('prevBtn').disabled = (stepIndex === 0);
            if(step === 'summary') document.getElementById('nextBtn').style.display = 'none'; else document.getElementById('nextBtn').style.display = 'block';
        }

        function renderSlider(label, key, val, min, max, suffix, color='') {
            const colorClass = color==='mythic'?'mythic-color':(color==='legendary'?'legendary-color':(color==='epic'?'epic-color':''));
            const fillPercent = (val / max) * 100;
            return `
                <div class="question-title">${label} <span class="tooltip-btn" onclick="openModal('${getTooltip(key)}')">?</span></div>
                <div class="slider-block">
                    <div class="number-display"><input type="number" id="${key}Input" value="${val}" min="${min}" max="${max}" step="1" oninput="updateFromInput('${key}', this.value)"></div>
                    <div class="slider-container">
                        <input type="range" id="${key}Slider" min="${min}" max="${max}" value="${val}" step="1" oninput="updateFromSlider('${key}', this.value)">
                    </div>
                    <div class="limit-indicator"><span class="${colorClass}">${val} / ${max}</span> <span>${suffix}</span></div>
                    <div class="progress-bar-bg"><div class="progress-fill" style="width:${fillPercent}%;"></div></div>
                </div>
            `;
        }

        function renderRanksUI() {
            return `
                <div class="question-title">×“×™×¨×•×’ ×¢×•× ×ª×™ <span class="tooltip-btn" onclick="openModal('×‘×—×¨ ×“×™×¨×•×’ ×œ-MP, BR, DMZ')">?</span></div>
                <div class="rank-tabs" id="rankTabs">
                    <button class="rank-tab active" onclick="showRankPanel('mp')">MP</button>
                    <button class="rank-tab" onclick="showRankPanel('br')">BR</button>
                    <button class="rank-tab" onclick="showRankPanel('dmz')">DMZ</button>
                </div>
                <div id="rankPanelMP" class="rank-panel">${rankSlider('MP', accountData.rankMP)}</div>
                <div id="rankPanelBR" class="rank-panel hidden">${rankSlider('BR', accountData.rankBR)}</div>
                <div id="rankPanelDMZ" class="rank-panel hidden">${rankSlider('DMZ', accountData.rankDMZ)}</div>
            `;
        }

        function rankSlider(name, val) {
            const maxRank = 8+5+5+1; // PRO I-V (5), MASTER I-V (5), GRANDMASTER I-V (5), LEGENDARY (1) = 16? × ×©×ª××© ×‘-0-16
            return `
                <div class="slider-header">${name} <span>${rankToText(val)}</span></div>
                <input type="range" min="0" max="16" value="${val}" step="1" onchange="updateRank('${name.toLowerCase()}', this.value)">
                <div class="progress-bar-bg"><div class="progress-fill" style="width:${(val/16)*100}%"></div></div>
            `;
        }

        function rankToText(r) {
            if(r<=4) return 'PRO ' + ['I','II','III','IV','V'][r];
            if(r<=9) return 'MASTER ' + ['I','II','III','IV','V'][r-5];
            if(r<=14) return 'GRAND MASTER ' + ['I','II','III','IV','V'][r-10];
            if(r===15) return 'LEGENDARY';
            return 'LEGENDARY';
        }

        window.showRankPanel = function(p) {
            document.querySelectorAll('.rank-panel').forEach(el=>el.classList.add('hidden'));
            document.getElementById(`rankPanel${p.toUpperCase()}`).classList.remove('hidden');
            document.querySelectorAll('.rank-tab').forEach((btn,i)=>{
                btn.classList.remove('active');
                if((i===0 && p==='mp')||(i===1&&p==='br')||(i===2&&p==='dmz')) btn.classList.add('active');
            });
        };
        window.updateRank = function(type, val) {
            accountData['rank'+type.toUpperCase()] = parseInt(val,10);
            updateBalanceDisplay(computeTotalValue());
            saveToStorage();
            renderRanksUI(); // refresh
        };

        window.setAccountType = function(disc) { accountData.discounted = disc; updateUI(); saveToStorage(); };
        window.setRareExist = function(val) { accountData.rareCharExist = val; if(!val) accountData.rareCharAmount=0; updateUI(); saveToStorage(); };
        window.updateFromSlider = function(key, val) { accountData[key] = parseInt(val,10)||0; updateUI(); saveToStorage(); };
        window.updateFromInput = function(key, val) { let v=parseInt(val,10); if(isNaN(v)) v=0; accountData[key] = Math.min(v, LIMITS[key]||9999); updateUI(); saveToStorage(); };

        function attachSliderListeners(step) { /* nothing extra */ }
        function getTooltip(key) {
            const tips = {
                years:'×•×•×ª×§ ×©× ×™× ××©×¤×™×¢ ×¢×œ ××—×™×¨', mythicWeapons:'× ×©×§ ××™×˜×™×§ (××“×•×)', mythicWeaponsMax:'MAX ××—×¨×™ ×©×“×¨×•×’',
                legWeapons:'×œ×’×³× ×“×¨×™ (×›×ª×•×-×¦×”×•×‘)', epicWeapons:'××¤×™×§ (×¡×’×•×œ)', mythicChars:'×“××•×™×•×ª ××™×˜×™×§',
                legChars:'×“××•×™×•×ª ×œ×’×³× ×“×¨×™', epicChars:'×“××•×™×•×ª ××¤×™×§', rareCharAmount:'×“××•×™×•×ª ××’×“×™×•×ª × ×“×™×¨×•×ª',
                level:'×¨××ª ×”×—×©×‘×•×Ÿ (×¢×“ 400)', ranks:'×“×™×¨×•×’ ×¢×•× ×ª×™ - ×›×œ ×¨××” = 1â‚ª'
            };
            return tips[key] || '××™×“×¢';
        }

        window.openModal = function(text) { document.getElementById('modalText').innerText = text; document.getElementById('infoModal').style.display='flex'; };
        window.closeModal = function() { document.getElementById('infoModal').style.display='none'; };

        function updateUI() { getCurrentStepUI(); }
        window.nextStep = function() { if(stepIndex < steps.length-1) { stepIndex++; updateUI(); saveToStorage(); } else if(stepIndex===steps.length-1) { stepIndex++; updateUI(); } };
        window.prevStep = function() { if(stepIndex>0) { stepIndex--; updateUI(); saveToStorage(); } };

        window.startCalculator = function() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('calculatorScreen').classList.remove('hidden');
            if(loadFromStorage()) {
                document.getElementById('memoryToast').style.display='block';
            } else { resetData(); }
            updateUI();
        };

        function resetData() {
            accountData = { discounted: true, years:0, mythicWeapons:0, mythicWeaponsMax:0, legWeapons:0, epicWeapons:0, mythicChars:0, mythicCharsMax:0, legChars:0, epicChars:0, rareCharExist:false, rareCharAmount:0, level:0, rankMP:0, rankBR:0, rankDMZ:0 };
            stepIndex=0;
        }
        window.resetToWelcome = function() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('calculatorScreen').classList.add('hidden');
            resetData();
        };
        window.saveAndShowHome = function() { saveToStorage(); resetToWelcome(); };

        // ××™×ª×—×•×œ
        if(loadFromStorage()) {
            document.getElementById('memoryToast').style.display='block';
        }
    })();
</script>
</body>
</html>