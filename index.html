<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>CODM Account Value Calculator</title>

  <style>
    :root{
      --bg:#070a10;
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.68);

      /* gamer neon */
      --aqua:#27e6ff;
      --aqua2:#18b7ff;
      --green:#27ff72;
      --red:#ff3b5c;
      --orange:#ffb020;
      --purple:#b06bff;

      --soft: rgba(255,255,255,.06);
      --soft2: rgba(255,255,255,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Heebo", "Rubik", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 70% 15%, rgba(39,230,255,.18), transparent 55%),
        radial-gradient(900px 520px at 25% 85%, rgba(176,107,255,.13), transparent 58%),
        radial-gradient(700px 420px at 50% 55%, rgba(39,255,114,.08), transparent 60%),
        linear-gradient(180deg, #060914, #070a10 30%, #060914);
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* subtle animated glow */
    .glow{
      position:fixed;
      inset:-30%;
      background: radial-gradient(circle at 40% 40%, rgba(39,230,255,.08), transparent 55%),
                  radial-gradient(circle at 60% 60%, rgba(39,255,114,.06), transparent 60%);
      filter: blur(18px);
      pointer-events:none;
      animation: drift 10s ease-in-out infinite alternate;
      z-index:-1;
    }
    @keyframes drift{
      from{ transform: translate3d(-1.5%, -1%, 0) scale(1); opacity:.9; }
      to{ transform: translate3d(1.5%, 1%, 0) scale(1.02); opacity:1; }
    }

    .wrap{
      min-height:100%;
      padding:18px 14px 30px;
      display:flex;
      justify-content:center;
    }
    .app{
      width:min(980px, 100%);
    }

    /* Top money (center, big, neon) */
    .top{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding:10px 0 4px;
    }
    .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:14px;
      color:rgba(234,242,255,.80);
      text-align:center;
      user-select:none;
    }
    .money{
      font-variant-numeric: tabular-nums;
      font-size:46px;
      line-height:1.0;
      font-weight:1000;
      color:var(--green);
      text-shadow:
        0 0 16px rgba(39,255,114,.24),
        0 0 40px rgba(39,255,114,.10);
      text-align:center;
      user-select:none;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* Stage area (no boxes) */
    .stage{
      margin-top:14px;
      padding:14px 0 0;
    }

    .welcome{
      text-align:center;
      padding:18px 0 6px;
    }
    .welcome h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
    }
    .welcome p{
      margin:10px 0 0;
      color:var(--muted);
      line-height:1.55;
      font-size:14px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      font-weight:900;
      padding:14px 16px;
      border-radius: 18px;
      width:100%;
      color:rgba(234,242,255,.95);
      background: linear-gradient(180deg, rgba(39,230,255,.18), rgba(39,230,255,.08));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      transition: transform .12s ease, filter .18s ease;
      touch-action:manipulation;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }

    .btnRow{
      margin-top:14px;
      display:grid;
      gap:10px;
      justify-items:center;
    }
    .btnRow .btn{
      max-width:420px;
    }

    /* Step */
    .step{
      display:none;
      padding:10px 0 0;
      animation: fadeUp .16s ease;
    }
    .step.active{ display:block; }
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .q{
      text-align:center;
      margin: 10px 0 6px;
      font-weight:1000;
      font-size:20px;
      letter-spacing:.2px;
    }

    .help{
      text-align:center;
      margin:6px 0 0;
      font-size:13px;
    }
    .help a{
      color:rgba(39,230,255,.98);
      text-decoration:none;
      font-weight:900;
      border-bottom: 1px dashed rgba(39,230,255,.55);
      padding-bottom:1px;
    }

    /* Choices */
    .choices2{
      margin:14px auto 0;
      max-width:520px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .chip{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 18px;
      padding:16px 14px;
      font-weight:1000;
      background: rgba(255,255,255,.06);
      color: rgba(234,242,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      transition: transform .12s ease, filter .18s ease, background .18s ease;
      touch-action:manipulation;
      user-select:none;
    }
    .chip:active{ transform: scale(.99); }
    .chip.selected{
      background: linear-gradient(180deg, rgba(39,230,255,.20), rgba(39,230,255,.08));
      filter: drop-shadow(0 0 16px rgba(39,230,255,.18));
    }

    /* Numeric area (minimal, no boxes) */
    .numArea{
      margin:14px auto 0;
      max-width:560px;
      display:grid;
      gap:12px;
      align-items:center;
      justify-items:center;
      padding: 6px 0;
    }

    .bigNum{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      user-select:none;
    }
    .bigNum .n{
      font-size:56px;
      font-weight:1100;
      font-variant-numeric: tabular-nums;
      letter-spacing:.6px;
      line-height:1;
    }
    .bigNum .unit{
      color:var(--muted);
      font-weight:900;
      font-size:13px;
      margin-top:8px;
    }

    /* super clean input (select-all on focus handled in JS) */
    .numInput{
      width:min(360px, 92vw);
      padding:14px 16px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(234,242,255,.95);
      font-size:18px;
      font-weight:1000;
      text-align:center;
      outline:none;
      -webkit-appearance:none;
      appearance:none;
    }
    .numInput:focus{
      border-color: rgba(39,230,255,.40);
      box-shadow: 0 0 0 3px rgba(39,230,255,.12);
    }

    .rangeWrap{
      width:min(560px, 92vw);
      display:grid;
      gap:8px;
    }
    .frac{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    input[type="range"]{
      width:100%;
      height: 30px;
      background: transparent;
      margin: 0;
      accent-color: var(--aqua);
      touch-action: pan-x;
    }

    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(39,230,255,.55), rgba(39,230,255,.18));
      transition: width .12s linear;
    }

    /* nav */
    .nav{
      margin:18px auto 0;
      max-width:560px;
      display:flex;
      gap:12px;
    }
    .nav button{
      flex:1;
      appearance:none;
      border:none;
      border-radius: 18px;
      padding:14px 14px;
      font-weight:1000;
      cursor:pointer;
      background: rgba(255,255,255,.06);
      color: rgba(234,242,255,.92);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      touch-action:manipulation;
      user-select:none;
    }
    .nav button.primary{
      background: linear-gradient(180deg, rgba(39,230,255,.18), rgba(39,230,255,.08));
    }
    .nav button:disabled{ opacity:.45; cursor:not-allowed; }

    /* rarity colors */
    .mythic{ color: var(--red); text-shadow: 0 0 14px rgba(255,59,92,.18); }
    .legendary{ color: var(--orange); text-shadow: 0 0 14px rgba(255,176,32,.16); }
    .epic{ color: var(--purple); text-shadow: 0 0 14px rgba(176,107,255,.16); }
    .neg{ color: var(--red); }

    /* CP coin tiny icon */
    .coin{
      width:44px;
      height:44px;
      object-fit:contain;
      margin-inline:6px;
      transform: translateY(2px);
      filter: drop-shadow(0 0 10px rgba(39,230,255,.20));
      user-select:none;
      pointer-events:none;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px 14px;
      z-index:999;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(560px, 100%);
      background: rgba(8,12,20,.82);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .mHead{
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mHead b{ font-size:14px; letter-spacing:.2px; }
    .x{
      width:44px; height:44px;
      border-radius: 16px;
      border:none;
      background: rgba(255,255,255,.06);
      cursor:pointer;
      display:grid; place-items:center;
      touch-action:manipulation;
    }
    .x:active{ transform: scale(.99); }
    .mBody{
      padding:0 14px 16px;
      color: rgba(234,242,255,.86);
      line-height:1.55;
      font-size:14px;
      white-space:pre-line;
    }

    @media (min-width: 760px){
      .money{ font-size:54px; }
      .welcome h1{ font-size:30px; }
    }
  </style>
</head>

<body>
  <div class="glow"></div>

  <div class="wrap">
    <div class="app">

      <div class="top">
        <div class="title">שווי השקעה בחשבון</div>
        <div class="money" id="moneyDisplay">0.00₪</div>
        <div class="sub">הסכום מתעדכן בזמן אמת לפי הבחירות שלך</div>
      </div>

      <div class="stage">

        <section class="welcome" id="welcome">
          <h1>CODM Account Value</h1>
          <p>מחשבון גיימינג נקי — שאלה אחת בכל פעם. בלי בלגן, בלי טפסים מכוערים.</p>
          <div class="btnRow">
            <button class="btn" id="startBtn">התחל חישוב חשבון</button>
          </div>
        </section>

        <section id="stepsHost"></section>

      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="mHead">
        <b id="mTitle">מידע</b>
        <button class="x" id="mClose" aria-label="סגור">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18" stroke="rgba(234,242,255,.92)" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="mBody" id="mBody"></div>
    </div>
  </div>

  <script>
    /*****************************************************************
     *  כל הערכים לשינוי נמצאים כאן (מחירים/מגבלות)
     *****************************************************************/

    const STORAGE_KEY = "codm_value_calc_v2";

    const ACCOUNT = { DISCOUNT:"discount", REGULAR:"regular" };

    // שווי CP: 3.24 אגורות = 0.0324₪ (ללא קשר לסוג חשבון)
    const CP_VALUE_ILS = 0.0324;

    const PRICING = {
      [ACCOUNT.DISCOUNT]: {
        years: 40,
        mythicWeapon: 210,
        mythicWeaponMaxUpgrade: 89,
        legendaryWeapon: 160,
        epicWeapon: 1,
        mythicOperator: 250,
        mythicOperatorMaxUpgrade: 110,
        legendaryOperator: 170,
        epicOperator: 1,
        rareLegendaryOperator: 80,
        accountLevel: 0.50,
        seasonalRankStep: 1
      },
      [ACCOUNT.REGULAR]: {
        years: 40,
        mythicWeapon: 420,
        mythicWeaponMaxUpgrade: 380,
        legendaryWeapon: 350,
        epicWeapon: 2,
        mythicOperator: 450,
        mythicOperatorMaxUpgrade: 350,
        legendaryOperator: 400,
        epicOperator: 1,
        rareLegendaryOperator: 120,
        accountLevel: 0.50,
        seasonalRankStep: 1
      }
    };

    const LIMITS = {
      // כאן משנים מגבלות
      cpMax: 100000,                 // מקסימום CP (אם תרצה להקטין/להגדיל)
      yearsMax: 9,
      mythicWeaponsMax: 32,
      legendaryWeaponsMax: 255,
      epicWeaponsMax: 991,
      mythicOperatorsMax: 7,
      legendaryOperatorsMax: 28,
      epicOperatorsMax: 1000,
      rareLegendaryOperatorsMax: 100,
      accountLevelMax: 400
    };

    const SEASONAL_MODES = ["mp","br","dmz"];

    const RANK_GROUPS = [
      { key:"PRO", label:"PRO", color:"var(--aqua)", steps:["I","II","III","IV","V"] },
      { key:"MASTER", label:"MASTER", color:"var(--purple)", steps:["I","II","III","IV","V"] },
      { key:"GRAND_MASTER", label:"GRAND MASTER", color:"var(--orange)", steps:["I","II","III","IV","V"] },
      { key:"LEGENDARY", label:"LEGENDARY", color:"var(--red)", steps:[""] }
    ];

    const state = {
      // CP step
      cpSign: "plus",          // "plus" / "minus"
      cpAmount: 0,             // מספר חיובי תמיד. אם מינוס => מורידים מההשקעה

      // existing
      accountType: null,
      years: 0,

      mythicWeapons: 0,
      mythicWeaponsMax: 0,
      legendaryWeapons: 0,
      epicWeapons: 0,

      mythicOperators: 0,
      mythicOperatorsMax: 0,
      legendaryOperators: 0,
      epicOperators: 0,

      hasRareLegendaryOperators: false,
      rareLegendaryOperators: 0,

      accountLevel: 0,
      seasonal: { mp:null, br:null, dmz:null },

      investmentValue: 0
    };

    /*****************************************************************
     * Money animation (center)
     *****************************************************************/
    const moneyEl = document.getElementById("moneyDisplay");
    let moneyRAF = null;

    function formatILS(n){
      const v = Number.isFinite(n) ? n : 0;
      return v.toFixed(2) + "₪";
    }

    function animateMoneyTo(target){
      const from = parseFloat((moneyEl.textContent || "0").replace("₪","")) || 0;
      const start = performance.now();
      const dur = 320;

      if (moneyRAF) cancelAnimationFrame(moneyRAF);

      const tick = (t) => {
        const p = Math.min(1, (t - start) / dur);
        const eased = 1 - Math.pow(1 - p, 3);
        const val = from + (target - from) * eased;
        moneyEl.textContent = formatILS(val);
        if (p < 1) moneyRAF = requestAnimationFrame(tick);
      };
      moneyRAF = requestAnimationFrame(tick);
    }

    function seasonalStepsCount(){
      let c = 0;
      for (const m of SEASONAL_MODES) if (state.seasonal[m]) c += 1;
      return c;
    }

    function recalcInvestment(){
      // אם עוד לא נבחר סוג חשבון – עדיין אפשר לחשב CP (כי זה לפני) אבל נשמור סכום כ-0 עד שבוחרים סוג?
      // לפי הבקשה שלך: הסכום צריך להתעדכן "כבר מהשאלה הראשונה".
      // לכן: CP כן משפיע מהתחלה, וכל השאר יחכה עד accountType.
      let total = 0;

      // CP value always counts (plus adds, minus subtracts)
      const cpWorth = state.cpAmount * CP_VALUE_ILS;
      total += (state.cpSign === "minus") ? (-cpWorth) : (cpWorth);

      if (state.accountType){
        const P = PRICING[state.accountType];

        state.mythicWeaponsMax = Math.min(state.mythicWeaponsMax, state.mythicWeapons);
        state.mythicOperatorsMax = Math.min(state.mythicOperatorsMax, state.mythicOperators);
        if (!state.hasRareLegendaryOperators) state.rareLegendaryOperators = 0;

        total +=
          (state.years * P.years) +

          (state.mythicWeapons * P.mythicWeapon) +
          (state.mythicWeaponsMax * P.mythicWeaponMaxUpgrade) +
          (state.legendaryWeapons * P.legendaryWeapon) +
          (state.epicWeapons * P.epicWeapon) +

          (state.mythicOperators * P.mythicOperator) +
          (state.mythicOperatorsMax * P.mythicOperatorMaxUpgrade) +
          (state.legendaryOperators * P.legendaryOperator) +
          (state.epicOperators * P.epicOperator) +
          (state.rareLegendaryOperators * P.rareLegendaryOperator) +

          (state.accountLevel * P.accountLevel) +

          (seasonalStepsCount() * P.seasonalRankStep);
      }

      state.investmentValue = total;
      animateMoneyTo(total);
      saveToStorage();
    }

    /*****************************************************************
     * Modal
     *****************************************************************/
    const overlay = document.getElementById("overlay");
    const mTitle = document.getElementById("mTitle");
    const mBody = document.getElementById("mBody");
    const mClose = document.getElementById("mClose");

    function openModal(title, text){
      mTitle.textContent = title || "מידע";
      mBody.textContent = text || "";
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
    }
    mClose.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && overlay.classList.contains("show")) closeModal(); });

    /*****************************************************************
     * Storage
     *****************************************************************/
    function saveToStorage(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ savedAt: Date.now(), state }));
      }catch(_e){}
    }
    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      }catch(_e){ return null; }
    }
    function resetAll(){
      state.cpSign = "plus";
      state.cpAmount = 0;

      state.accountType = null;
      state.years = 0;

      state.mythicWeapons = 0;
      state.mythicWeaponsMax = 0;
      state.legendaryWeapons = 0;
      state.epicWeapons = 0;

      state.mythicOperators = 0;
      state.mythicOperatorsMax = 0;
      state.legendaryOperators = 0;
      state.epicOperators = 0;

      state.hasRareLegendaryOperators = false;
      state.rareLegendaryOperators = 0;

      state.accountLevel = 0;
      state.seasonal.mp = null;
      state.seasonal.br = null;
      state.seasonal.dmz = null;

      state.investmentValue = 0;
      saveToStorage();
      animateMoneyTo(0);
    }

    /*****************************************************************
     * Step engine
     *****************************************************************/
    const stepsHost = document.getElementById("stepsHost");
    const welcome = document.getElementById("welcome");
    const startBtn = document.getElementById("startBtn");

    let currentStepIndex = 0;
    const stepEls = [];

    function showStep(i){
      stepEls.forEach((el, idx) => el.classList.toggle("active", idx === i));
      currentStepIndex = i;
      const active = stepEls[i];
      if (active) active.scrollIntoView({ behavior:"smooth", block:"start" });
    }
    function findStepIndex(id){
      return stepEls.findIndex(el => el.dataset.stepId === id);
    }

    function nextStep(){
      const id = stepEls[currentStepIndex]?.dataset?.stepId;

      // skips
      if (id === "mythicWeapons" && state.mythicWeapons <= 0){
        const idx = findStepIndex("mythicWeaponsMax");
        if (idx !== -1) return showStep(idx + 1);
      }
      if (id === "mythicOperators" && state.mythicOperators <= 0){
        const idx = findStepIndex("mythicOperatorsMax");
        if (idx !== -1) return showStep(idx + 1);
      }
      if (id === "hasRareLegendaryOperators" && !state.hasRareLegendaryOperators){
        const idx = findStepIndex("rareLegendaryOperators");
        if (idx !== -1) return showStep(idx + 1);
      }
      if (id === "seasonalRank"){
        const sumIdx = findStepIndex("summary");
        if (sumIdx !== -1){
          const sumEl = stepEls[sumIdx];
          if (sumEl && sumEl.refreshSummary) sumEl.refreshSummary();
          return showStep(sumIdx);
        }
      }

      showStep(Math.min(stepEls.length - 1, currentStepIndex + 1));
    }

    function prevStep(){
      const id = stepEls[currentStepIndex]?.dataset?.stepId;

      if (id === "legendaryWeapons" && state.mythicWeapons <= 0){
        const mythIdx = findStepIndex("mythicWeapons");
        if (mythIdx !== -1) return showStep(mythIdx);
      }
      if (id === "legendaryOperators" && state.mythicOperators <= 0){
        const mythOpIdx = findStepIndex("mythicOperators");
        if (mythOpIdx !== -1) return showStep(mythOpIdx);
      }
      if (id === "accountLevel" && !state.hasRareLegendaryOperators){
        const ynIdx = findStepIndex("hasRareLegendaryOperators");
        if (ynIdx !== -1) return showStep(ynIdx);
      }

      showStep(Math.max(0, currentStepIndex - 1));
    }

    /*****************************************************************
     * UI builders (clean)
     *****************************************************************/
    function makeStep(stepId, questionText, helpLabel, helpTitle, helpBody){
      const sec = document.createElement("section");
      sec.className = "step";
      sec.dataset.stepId = stepId;

      const q = document.createElement("div");
      q.className = "q";
      q.textContent = questionText;

      sec.appendChild(q);

      if (helpLabel){
        const help = document.createElement("div");
        help.className = "help";
        const a = document.createElement("a");
        a.href = "javascript:void(0)";
        a.textContent = helpLabel;
        a.addEventListener("click", () => openModal(helpTitle, helpBody));
        help.appendChild(a);
        sec.appendChild(help);
      }

      return sec;
    }

    function makeNav(sec, { nextText="הבא", prevText="חזור", hidePrev=false, nextEnabled=true } = {}){
      const nav = document.createElement("div");
      nav.className = "nav";

      const prev = document.createElement("button");
      prev.type = "button";
      prev.textContent = prevText;
      prev.addEventListener("click", prevStep);

      const next = document.createElement("button");
      next.type = "button";
      next.className = "primary";
      next.textContent = nextText;
      next.disabled = !nextEnabled;
      next.addEventListener("click", nextStep);

      if (!hidePrev) nav.appendChild(prev);
      nav.appendChild(next);

      sec.appendChild(nav);
      return { prevBtn: prev, nextBtn: next };
    }

    function clampInt(v, min, max){
      const n = parseInt(String(v).replace(/[^\d]/g,''), 10);
      if (!Number.isFinite(n)) return min;
      return Math.min(max, Math.max(min, n));
    }

    function wireSelectAllOnFocus(input){
      // הופך הקלדה לחלקה: לחיצה => מסמן הכל מיד (לא צריך לתפוס את "0")
      input.addEventListener("focus", () => {
        requestAnimationFrame(() => input.select());
      });
      input.addEventListener("mouseup", (e) => {
        // מונע ביטול select במובייל/דסקטופ
        e.preventDefault();
      });
    }

    function makeNumberStep({
      stepId, questionText, helpLabel, helpTitle, helpBody,
      rarityClass, unitLabel,
      min=0, max=100,
      getValue, setValue,
      onChange
    }){
      const sec = makeStep(stepId, questionText, helpLabel, helpTitle, helpBody);

      const area = document.createElement("div");
      area.className = "numArea";

      const big = document.createElement("div");
      big.className = "bigNum";

      const n = document.createElement("div");
      n.className = "n";
      if (rarityClass) n.classList.add(rarityClass);
      n.textContent = String(getValue());

      const unit = document.createElement("div");
      unit.className = "unit";
      unit.textContent = unitLabel || "";

      big.appendChild(n);
      big.appendChild(unit);

      const input = document.createElement("input");
      input.className = "numInput";
      input.type = "text";
      input.inputMode = "numeric";
      input.autocomplete = "off";
      input.spellcheck = false;
      input.value = String(getValue());
      input.setAttribute("aria-label", questionText);

      wireSelectAllOnFocus(input);

      const rangeWrap = document.createElement("div");
      rangeWrap.className = "rangeWrap";

      const frac = document.createElement("div");
      frac.className = "frac";
      const left = document.createElement("span");
      left.textContent = "מגבלה";
      const right = document.createElement("span");
      right.textContent = `${getValue()}/${max}`;
      frac.appendChild(left);
      frac.appendChild(right);

      const slider = document.createElement("input");
      slider.type = "range";
      slider.min = String(min);
      slider.max = String(max);
      slider.step = "1";
      slider.value = String(getValue());

      const bar = document.createElement("div");
      bar.className = "bar";
      const fill = document.createElement("div");
      fill.className = "fill";
      bar.appendChild(fill);

      function sync(v){
        n.textContent = String(v);
        input.value = String(v);
        slider.value = String(v);
        right.textContent = `${v}/${max}`;
        fill.style.width = (max === 0 ? 0 : (v / max) * 100) + "%";
      }

      sync(getValue());

      slider.addEventListener("input", () => {
        const v = clampInt(slider.value, min, max);
        setValue(v);
        sync(v);
        onChange && onChange(v);
      });

      input.addEventListener("input", () => {
        const cleaned = String(input.value).replace(/[^\d]/g,'');
        const v = cleaned === "" ? 0 : clampInt(cleaned, min, max);
        setValue(v);
        sync(v);
        onChange && onChange(v);
      });

      rangeWrap.appendChild(frac);
      rangeWrap.appendChild(slider);
      rangeWrap.appendChild(bar);

      area.appendChild(big);
      area.appendChild(input);
      area.appendChild(rangeWrap);

      sec.appendChild(area);

      const nav = makeNav(sec, { nextEnabled:true });
      return { sec, nav, sync };
    }

    function makeTwoChoiceStep({
      stepId, questionText,
      helpLabel, helpTitle, helpBody,
      leftLabel, rightLabel,
      onPick
    }){
      const sec = makeStep(stepId, questionText, helpLabel, helpTitle, helpBody);

      const grid = document.createElement("div");
      grid.className = "choices2";

      const b1 = document.createElement("button");
      b1.className = "chip";
      b1.type = "button";
      b1.textContent = leftLabel;

      const b2 = document.createElement("button");
      b2.className = "chip";
      b2.type = "button";
      b2.textContent = rightLabel;

      function select(which){
        b1.classList.toggle("selected", which === 1);
        b2.classList.toggle("selected", which === 2);
      }

      b1.addEventListener("click", () => { select(1); onPick(1); });
      b2.addEventListener("click", () => { select(2); onPick(2); });

      grid.appendChild(b1);
      grid.appendChild(b2);

      sec.appendChild(grid);

      const nav = makeNav(sec, { nextEnabled:false });
      return { sec, nav, select };
    }

    /* CP Step UI */
    function makeCPStep(){
      const sec = makeStep(
        "cp",
        "כמה מטבעות CP קיימים בחשבון",
        null, "", ""
      );

      const area = document.createElement("div");
      area.className = "numArea";

      const big = document.createElement("div");
      big.className = "bigNum";

      const n = document.createElement("div");
      n.className = "n";
      n.textContent = "0";

      const unit = document.createElement("div");
      unit.className = "unit";
      unit.innerHTML = `
CP 
<img 
  alt="CP" 
  src="https://i.postimg.cc/15X8dgj9/Cp-nqy.png"
  style="
    width:38px;
    height:38px;
    object-fit:contain;
    display:inline-block;
    vertical-align:middle;
    margin-inline:6px;
  "
>
`;


      big.appendChild(n);
      big.appendChild(unit);

      // plus/minus choice
      const grid = document.createElement("div");
      grid.className = "choices2";
      grid.style.maxWidth = "420px";

      const plus = document.createElement("button");
      plus.className = "chip selected";
      plus.type = "button";
      plus.textContent = "פלוס (CP רגיל)";

      const minus = document.createElement("button");
      minus.className = "chip";
      minus.type = "button";
      minus.textContent = "מינוס (CP בחוב)";

      const note = document.createElement("div");
      note.style.textAlign = "center";
      note.style.color = "var(--muted)";
      note.style.fontSize = "13px";
      note.style.fontWeight = "900";
      note.style.marginTop = "6px";
      note.textContent = "במידה ויש מינוס CP — בחר במינוס ואז גרור/הקלד את הכמות.";

      grid.appendChild(plus);
      grid.appendChild(minus);

      // slider/input (same control, but number turns red and shown with - if minus)
      const input = document.createElement("input");
      input.className = "numInput";
      input.type = "text";
      input.inputMode = "numeric";
      input.autocomplete = "off";
      input.spellcheck = false;
      input.value = "0";
      wireSelectAllOnFocus(input);

      const rangeWrap = document.createElement("div");
      rangeWrap.className = "rangeWrap";

      const frac = document.createElement("div");
      frac.className = "frac";
      const left = document.createElement("span");
      left.textContent = "מגבלה";
      const right = document.createElement("span");
      right.textContent = `0/${LIMITS.cpMax}`;
      frac.appendChild(left);
      frac.appendChild(right);

      const slider = document.createElement("input");
      slider.type = "range";
      slider.min = "0";
      slider.max = String(LIMITS.cpMax);
      slider.step = "1";
      slider.value = "0";

      const bar = document.createElement("div");
      bar.className = "bar";
      const fill = document.createElement("div");
      fill.className = "fill";
      bar.appendChild(fill);

      function applySignUI(){
        const isMinus = state.cpSign === "minus";
        plus.classList.toggle("selected", !isMinus);
        minus.classList.toggle("selected", isMinus);
        n.classList.toggle("neg", isMinus);
      }

      function sync(v){
        state.cpAmount = v;

        const isMinus = state.cpSign === "minus";
        const shown = isMinus ? `-${v}` : `${v}`;

        n.textContent = shown;
        input.value = String(v);
        slider.value = String(v);
        right.textContent = `${v}/${LIMITS.cpMax}`;
        fill.style.width = (LIMITS.cpMax === 0 ? 0 : (v / LIMITS.cpMax) * 100) + "%";

        recalcInvestment();
      }

      plus.addEventListener("click", () => {
        state.cpSign = "plus";
        applySignUI();
        sync(state.cpAmount);
      });

      minus.addEventListener("click", () => {
        state.cpSign = "minus";
        applySignUI();
        sync(state.cpAmount);
      });

      slider.addEventListener("input", () => {
        const v = clampInt(slider.value, 0, LIMITS.cpMax);
        sync(v);
      });

      input.addEventListener("input", () => {
        const cleaned = String(input.value).replace(/[^\d]/g,'');
        const v = cleaned === "" ? 0 : clampInt(cleaned, 0, LIMITS.cpMax);
        sync(v);
      });

      applySignUI();
      sync(0);

      rangeWrap.appendChild(frac);
      rangeWrap.appendChild(slider);
      rangeWrap.appendChild(bar);

      area.appendChild(big);
      area.appendChild(grid);
      area.appendChild(note);
      area.appendChild(input);
      area.appendChild(rangeWrap);

      sec.appendChild(area);

      const nav = makeNav(sec, { nextEnabled:true, hidePrev:true });
      return { sec, nav };
    }

    function buildFlatRanks(){
      const flat = [];
      for (const g of RANK_GROUPS){
        if (g.key === "LEGENDARY"){
          flat.push({ label:"LEGENDARY", color:g.color });
        } else {
          for (const s of g.steps){
            flat.push({ label:`${g.label} ${s}`, color:g.color });
          }
        }
      }
      return flat;
    }

    function makeSeasonalRankStep(){
      const sec = makeStep("seasonalRank", "מה רמת הדירוג העונתי של החשבון (RANK)", null, "", "");

      const row = document.createElement("div");
      row.style.maxWidth = "720px";
      row.style.margin = "14px auto 0";
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 1fr 1fr";
      row.style.gap = "12px";

      function modeBtn(label, key){
        const b = document.createElement("button");
        b.className = "chip";
        b.type = "button";
        b.textContent = label;
        b.dataset.mode = key;
        return b;
      }
      const bMP = modeBtn("Multiplayer", "mp");
      const bBR = modeBtn("Battle royal", "br");
      const bDMZ = modeBtn("DMZ", "dmz");
      row.appendChild(bMP); row.appendChild(bBR); row.appendChild(bDMZ);

      const panels = document.createElement("div");
      panels.style.maxWidth = "720px";
      panels.style.margin = "12px auto 0";
      panels.style.display = "grid";
      panels.style.gap = "12px";

      const flat = buildFlatRanks();
      const maxIdx = flat.length - 1;

      function panelFor(modeKey, title){
        const wrap = document.createElement("div");
        wrap.style.display = "none";
        wrap.dataset.panel = modeKey;

        const q = document.createElement("div");
        q.style.textAlign = "center";
        q.style.fontWeight = "1000";
        q.style.color = "rgba(234,242,255,.88)";
        q.style.marginBottom = "8px";
        q.textContent = title;

        const big = document.createElement("div");
        big.className = "bigNum";
        const label = document.createElement("div");
        label.className = "n";
        label.style.fontSize = "22px";
        label.style.letterSpacing = ".2px";
        label.style.width = "100%";
        label.style.textAlign = "center";
        label.textContent = "גרור כדי לבחור דירוג";
        label.style.color = "rgba(234,242,255,.65)";
        big.appendChild(label);

        const rangeWrap = document.createElement("div");
        rangeWrap.className = "rangeWrap";

        const frac = document.createElement("div");
        frac.className = "frac";
        const l = document.createElement("span"); l.textContent = "דירוג";
        const r = document.createElement("span"); r.textContent = "לא נבחר";
        frac.appendChild(l); frac.appendChild(r);

        const slider = document.createElement("input");
        slider.type = "range";
        slider.min = "0";
        slider.max = String(maxIdx);
        slider.step = "1";
        slider.value = "0";

        const bar = document.createElement("div");
        bar.className = "bar";
        const fill = document.createElement("div");
        fill.className = "fill";
        bar.appendChild(fill);

        function sync(){
          const chosen = state.seasonal[modeKey];
          if (!chosen){
            label.textContent = "גרור כדי לבחור דירוג";
            label.style.color = "rgba(234,242,255,.65)";
            r.textContent = "לא נבחר";
            slider.value = "0";
            fill.style.width = "0%";
            return;
          }
          const idx = flat.findIndex(x => x.label === chosen);
          const safe = idx < 0 ? 0 : idx;
          label.textContent = chosen;
          label.style.color = getComputedStyle(document.documentElement).getPropertyValue(flat[safe].color?.replace("var(","").replace(")","")) || flat[safe].color;
          // fallback: direct var color
          label.style.color = flat[safe].color;
          r.textContent = "נבחר";
          slider.value = String(safe);
          fill.style.width = (maxIdx === 0 ? 0 : (safe / maxIdx) * 100) + "%";
        }

        slider.addEventListener("input", () => {
          const idx = clampInt(slider.value, 0, maxIdx);
          state.seasonal[modeKey] = flat[idx].label;
          recalcInvestment();
          syncButtons();
          sync();
        });

        const clear = document.createElement("button");
        clear.className = "btn";
        clear.type = "button";
        clear.style.maxWidth = "260px";
        clear.style.justifySelf = "center";
        clear.style.marginTop = "10px";
        clear.textContent = "נקה בחירה";
        clear.addEventListener("click", () => {
          state.seasonal[modeKey] = null;
          recalcInvestment();
          syncButtons();
          sync();
        });

        rangeWrap.appendChild(frac);
        rangeWrap.appendChild(slider);
        rangeWrap.appendChild(bar);

        wrap.appendChild(q);
        wrap.appendChild(big);
        wrap.appendChild(rangeWrap);
        wrap.appendChild(clear);

        panels.appendChild(wrap);
        return { wrap, sync };
      }

      const pMP = panelFor("mp", "Multiplayer");
      const pBR = panelFor("br", "Battle royal");
      const pDMZ = panelFor("dmz", "DMZ");

      function open(mode){
        [pMP.wrap, pBR.wrap, pDMZ.wrap].forEach(w => w.style.display = "none");
        const target = (mode === "mp") ? pMP : (mode === "br") ? pBR : pDMZ;
        target.wrap.style.display = "block";
        target.sync();
      }

      function syncButtons(){
        bMP.classList.toggle("selected", !!state.seasonal.mp);
        bBR.classList.toggle("selected", !!state.seasonal.br);
        bDMZ.classList.toggle("selected", !!state.seasonal.dmz);
      }

      bMP.addEventListener("click", () => { open("mp"); });
      bBR.addEventListener("click", () => { open("br"); });
      bDMZ.addEventListener("click", () => { open("dmz"); });

      syncButtons();

      sec.appendChild(row);
      sec.appendChild(panels);

      const nav = makeNav(sec, { nextText:"לסיכום כמה שווה החשבון לי", nextEnabled:true });
      return { sec, nav };
    }

    function calcSaleValue(inv){
      const factor = (state.accountType === ACCOUNT.DISCOUNT) ? 0.35 : 0.55;
      return inv * factor;
    }

    function buildSummaryStep(){
      const sec = makeStep("summary", "סיכום מחיר", null, "", "");

      const area = document.createElement("div");
      area.className = "numArea";

      const invLine = document.createElement("div");
      invLine.style.textAlign = "center";
      invLine.style.color = "rgba(234,242,255,.82)";
      invLine.style.fontWeight = "1000";
      invLine.textContent = "שווי ההשקעה";

      const invVal = document.createElement("div");
      invVal.className = "money";
      invVal.style.fontSize = "44px";
      invVal.style.color = "var(--green)";

      const saleLine = document.createElement("div");
      saleLine.style.textAlign = "center";
      saleLine.style.color = "rgba(234,242,255,.82)";
      saleLine.style.fontWeight = "1000";
      saleLine.style.marginTop = "10px";
      saleLine.textContent = "שווי החשבון למכירה";

      const saleVal = document.createElement("div");
      saleVal.className = "money";
      saleVal.style.fontSize = "54px";
      saleVal.style.color = "var(--red)";
      saleVal.style.textShadow = "0 0 18px rgba(255,59,92,.20), 0 0 50px rgba(255,59,92,.10)";

      area.appendChild(invLine);
      area.appendChild(invVal);
      area.appendChild(saleLine);
      area.appendChild(saleVal);

      sec.appendChild(area);

      // buttons
      const nav = document.createElement("div");
      nav.className = "nav";

      const myBtn = document.createElement("button");
      myBtn.type = "button";
      myBtn.textContent = "חשבון שלי";

      const newBtn = document.createElement("button");
      newBtn.type = "button";
      newBtn.className = "primary";
      newBtn.textContent = "חשב חשבון חדש";

      myBtn.addEventListener("click", () => {
        saveToStorage();
        openModal("נשמר", "הנתונים נשמרו בדפדפן.\nבכניסה הבאה תוכל לפתוח סיכום או לחשב מחדש.");
      });

      newBtn.addEventListener("click", () => {
        resetAll();
        welcome.style.display = "";
        stepsHost.innerHTML = "";
        stepEls.length = 0;
      });

      nav.appendChild(myBtn);
      nav.appendChild(newBtn);
      sec.appendChild(nav);

      // refresh hook
      sec.refreshSummary = () => {
        recalcInvestment();
        invVal.textContent = formatILS(state.investmentValue);
        // one-shot animation for sale
        const target = calcSaleValue(state.investmentValue);
        // פשוט נשתמש ב-count קצר:
        const from = parseFloat((saleVal.textContent || "0").replace("₪","")) || 0;
        const start = performance.now();
        const dur = 420;
        const tick = (t) => {
          const p = Math.min(1, (t - start) / dur);
          const eased = 1 - Math.pow(1 - p, 3);
          const val = from + (target - from) * eased;
          saleVal.textContent = formatILS(val);
          if (p < 1) requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
      };

      return { sec };
    }

    function buildSteps(){
      stepsHost.innerHTML = "";
      stepEls.length = 0;

      // 0) CP
      const cp = makeCPStep();
      stepEls.push(cp.sec);
      stepsHost.appendChild(cp.sec);

      // 1) account type
      const s1 = makeTwoChoiceStep({
        stepId:"accountType",
        questionText:"בחר סוג חשבון",
        helpLabel:"איך אני יודע איזה סוג חשבון יש לי",
        helpTitle:"איך מזהים סוג חשבון",
        helpBody:"חשבון מוזל זה חשבון שנפתח בהודו או בישראל דרך VPN שמחובר להודו.\nאם אתם לא בטוחים: בחשבון מוזל פתיחות של הגרלות מתחילות ב־10 CP.\nבחשבון לא מוזל פתיחות מתחילות ב־30 CP.",
        leftLabel:"חשבון מוזל",
        rightLabel:"חשבון לא מוזל",
        onPick:(which)=>{
          state.accountType = (which === 1) ? ACCOUNT.DISCOUNT : ACCOUNT.REGULAR;
          s1.nav.nextBtn.disabled = false;
          recalcInvestment();
        }
      });
      stepEls.push(s1.sec);
      stepsHost.appendChild(s1.sec);

      // 2) years
      const s2 = makeNumberStep({
        stepId:"years",
        questionText:"מה וותק החשבון",
        helpLabel:null, helpTitle:"", helpBody:"",
        rarityClass:null,
        unitLabel:"שנים",
        min:0, max:LIMITS.yearsMax,
        getValue:()=>state.years,
        setValue:(v)=>{ state.years=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s2.sec); stepsHost.appendChild(s2.sec);

      // 3) mythic weapons
      const s3 = makeNumberStep({
        stepId:"mythicWeapons",
        questionText:"כמה נשקים מיטיק קיימים בחשבון",
        helpLabel:"מה זה מיטיק",
        helpTitle:"מה זה מיטיק",
        helpBody:"מיטיק זה נשק/דמות שאפשר לשדרג.\nבמשחק זה בדרך כלל מופיע בקטגוריה אדומה.",
        rarityClass:"mythic",
        unitLabel:"נשקים",
        min:0, max:LIMITS.mythicWeaponsMax,
        getValue:()=>state.mythicWeapons,
        setValue:(v)=>{ state.mythicWeapons=v; state.mythicWeaponsMax=Math.min(state.mythicWeaponsMax,v); },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s3.sec); stepsHost.appendChild(s3.sec);

      // 4) mythic weapons MAX
      const s4 = makeNumberStep({
        stepId:"mythicWeaponsMax",
        questionText:"כמה מתוכם ברמת מקסימום",
        helpLabel:"מה זה מקסימום",
        helpTitle:"מה זה מקסימום (MAX)",
        helpBody:"מקסימום (MAX) זה אומר נשק או דמות מיטיק ששודרגה לרמה המקסימלית.\nלא חצי מקסימום.",
        rarityClass:"mythic",
        unitLabel:"MAX",
        min:0, max:LIMITS.mythicWeaponsMax,
        getValue:()=>state.mythicWeaponsMax,
        setValue:(v)=>{ state.mythicWeaponsMax=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s4.sec); stepsHost.appendChild(s4.sec);

      // 5) legendary weapons
      const s5 = makeNumberStep({
        stepId:"legendaryWeapons",
        questionText:"כמה נשקי לג׳נדרי קיימים בחשבון",
        helpLabel:null, helpTitle:"", helpBody:"",
        rarityClass:"legendary",
        unitLabel:"נשקים",
        min:0, max:LIMITS.legendaryWeaponsMax,
        getValue:()=>state.legendaryWeapons,
        setValue:(v)=>{ state.legendaryWeapons=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s5.sec); stepsHost.appendChild(s5.sec);

      // 6) epic weapons
      const s6 = makeNumberStep({
        stepId:"epicWeapons",
        questionText:"כמה נשקי אפיק (Epic) קיימים בחשבון",
        helpLabel:null, helpTitle:"", helpBody:"",
        rarityClass:"epic",
        unitLabel:"נשקים",
        min:0, max:LIMITS.epicWeaponsMax,
        getValue:()=>state.epicWeapons,
        setValue:(v)=>{ state.epicWeapons=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s6.sec); stepsHost.appendChild(s6.sec);

      // ממשיכים בחלק 2…
      showStep(0);
      recalcInvestment();
    }

    startBtn.addEventListener("click", () => {
      welcome.style.display = "none";
      buildSteps();
    });

    // הצעה לפתיחה מהדפדפן
    (function resumePrompt(){
      const saved = loadFromStorage();
      if (!saved || !saved.state) return;
      if (!saved.state.accountType && (!saved.state.cpAmount || saved.state.cpAmount === 0)) return;

      openModal("מצאתי חישוב שמור", "רוצה להמשיך לחשבון האחרון שלך או להתחיל חדש?");
      const actions = document.createElement("div");
      actions.style.display = "grid";
      actions.style.gridTemplateColumns = "1fr 1fr";
      actions.style.gap = "10px";
      actions.style.marginTop = "12px";

      const goMy = document.createElement("button");
      goMy.className = "btn";
      goMy.textContent = "המשך לחשבון שלי";

      const goNew = document.createElement("button");
      goNew.className = "btn";
      goNew.style.background = "rgba(255,255,255,.06)";
      goNew.textContent = "חשב חדש";

      actions.appendChild(goMy);
      actions.appendChild(goNew);
      mBody.appendChild(actions);

      goMy.addEventListener("click", () => {
        Object.assign(state, saved.state);
        closeModal();
        welcome.style.display = "none";
        buildSteps();
        // נתקדם לסיכום בסוף חלק 2 (אחרי שיבנה)
      });

      goNew.addEventListener("click", () => {
        resetAll();
        closeModal();
      });
    })();

    // init
    animateMoneyTo(0);

    /* ======= לא לסגור script פה. ממשיכים בחלק 2 ======= */

        /*****************************************************************
     * PART 2 CONTINUE (בלי לפתוח <script> מחדש)
     *****************************************************************/

     function makeYesNoStep({
      stepId, questionText,
      helpLabel, helpTitle, helpBody,
      getBool, setBool
    }){
      const sec = makeStep(stepId, questionText, helpLabel, helpTitle, helpBody);

      const grid = document.createElement("div");
      grid.className = "choices2";
      grid.style.maxWidth = "420px";

      const yes = document.createElement("button");
      yes.className = "chip";
      yes.type = "button";
      yes.textContent = "כן";

      const no = document.createElement("button");
      no.className = "chip";
      no.type = "button";
      no.textContent = "לא";

      function sync(){
        const v = !!getBool();
        yes.classList.toggle("selected", v === true);
        no.classList.toggle("selected", v === false);
      }

      yes.addEventListener("click", () => { setBool(true); sync(); recalcInvestment(); });
      no.addEventListener("click", () => { setBool(false); sync(); recalcInvestment(); });

      grid.appendChild(yes); grid.appendChild(no);
      sec.appendChild(grid);

      const nav = makeNav(sec, { nextEnabled:true });
      sync();
      return { sec, nav };
    }

    function buildStepsContinue(){
      // מוסיף את ההמשך אחרי epicWeapons (שלב 6)
      // מניח ש-buildSteps כבר רץ ובנה עד epicWeapons
      // נבנה בהמשך ה-steps באותו host

      // 7) mythic operators
      const s7 = makeNumberStep({
        stepId:"mythicOperators",
        questionText:"כמה דמויות מיטיק קיימים בחשבון",
        helpLabel:"מה זה מיטיק",
        helpTitle:"מה זה מיטיק",
        helpBody:"מיטיק זה דמות שאפשר לשדרג.\nבמשחק זה בדרך כלל מופיע בקטגוריה אדומה.",
        rarityClass:"mythic",
        unitLabel:"דמויות",
        min:0, max:LIMITS.mythicOperatorsMax,
        getValue:()=>state.mythicOperators,
        setValue:(v)=>{ state.mythicOperators=v; state.mythicOperatorsMax=Math.min(state.mythicOperatorsMax,v); },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s7.sec); stepsHost.appendChild(s7.sec);

      // 8) mythic operators MAX
      const s8 = makeNumberStep({
        stepId:"mythicOperatorsMax",
        questionText:"כמה מהם ברמת מקסימום",
        helpLabel:"מה זה מקסימום",
        helpTitle:"מה זה מקסימום (MAX)",
        helpBody:"מקסימום (MAX) זה אומר דמות מיטיק ששודרגה לרמה המקסימלית.\nלא חצי מקסימום.",
        rarityClass:"mythic",
        unitLabel:"MAX",
        min:0, max:LIMITS.mythicOperatorsMax,
        getValue:()=>state.mythicOperatorsMax,
        setValue:(v)=>{ state.mythicOperatorsMax=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s8.sec); stepsHost.appendChild(s8.sec);

      // 9) legendary operators
      const s9 = makeNumberStep({
        stepId:"legendaryOperators",
        questionText:"כמה דמויות לג׳נדרי קיימים בחשבון",
        helpLabel:null, helpTitle:"", helpBody:"",
        rarityClass:"legendary",
        unitLabel:"דמויות",
        min:0, max:LIMITS.legendaryOperatorsMax,
        getValue:()=>state.legendaryOperators,
        setValue:(v)=>{ state.legendaryOperators=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s9.sec); stepsHost.appendChild(s9.sec);

      // 10) epic operators
      const s10 = makeNumberStep({
        stepId:"epicOperators",
        questionText:"כמה דמויות אפיק (Epic) קיימים בחשבון",
        helpLabel:null, helpTitle:"", helpBody:"",
        rarityClass:"epic",
        unitLabel:"דמויות",
        min:0, max:LIMITS.epicOperatorsMax,
        getValue:()=>state.epicOperators,
        setValue:(v)=>{ state.epicOperators=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s10.sec); stepsHost.appendChild(s10.sec);

      // 11) rare legendary operators yes/no
      const s11 = makeYesNoStep({
        stepId:"hasRareLegendaryOperators",
        questionText:"האם קיימים דמויות אגדיות נדירות בחשבון",
        helpLabel:null, helpTitle:"", helpBody:"",
        getBool:()=>state.hasRareLegendaryOperators,
        setBool:(v)=>{ state.hasRareLegendaryOperators=v; if(!v) state.rareLegendaryOperators=0; }
      });
      stepEls.push(s11.sec); stepsHost.appendChild(s11.sec);

      // 12) rare count
      const s12 = makeNumberStep({
        stepId:"rareLegendaryOperators",
        questionText:"כמה דמויות אגדיות נדירות קיימים בחשבון",
        helpLabel:null, helpTitle:"", helpBody:"",
        rarityClass:null,
        unitLabel:"דמויות",
        min:0, max:LIMITS.rareLegendaryOperatorsMax,
        getValue:()=>state.rareLegendaryOperators,
        setValue:(v)=>{ state.rareLegendaryOperators=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s12.sec); stepsHost.appendChild(s12.sec);

      // 13) account level
      const s13 = makeNumberStep({
        stepId:"accountLevel",
        questionText:"מה רמת החשבון",
        helpLabel:"מה זה רמת חשבון",
        helpTitle:"מה זה רמת חשבון",
        helpBody:"רמת חשבון הוא ה־Level בו החשבון שלכם.\nזה לא הדירוג העונתי.\nמקסימום הרמה הוא Level 400.",
        rarityClass:null,
        unitLabel:"Level",
        min:0, max:LIMITS.accountLevelMax,
        getValue:()=>state.accountLevel,
        setValue:(v)=>{ state.accountLevel=v; },
        onChange:()=>recalcInvestment()
      });
      stepEls.push(s13.sec); stepsHost.appendChild(s13.sec);

      // 14) seasonal rank
      const s14 = makeSeasonalRankStep();
      stepEls.push(s14.sec); stepsHost.appendChild(s14.sec);

      // 15) summary
      const sum = buildSummaryStep();
      stepEls.push(sum.sec); stepsHost.appendChild(sum.sec);
    }

    // מוסיפים את ההמשך אחרי buildSteps הראשוני
    const buildStepsBase = buildSteps;
    buildSteps = function(){
      buildStepsBase();
      buildStepsContinue();
      // אם הגענו מריסטור – ננסה לקפוץ לסיכום אם רצו
      recalcInvestment();
    };

    // עדכון של next/prev כדי לדלג על שלבים מותנים
    const _next = nextStep;
    nextStep = function(){
      const id = stepEls[currentStepIndex]?.dataset?.stepId;

      if (id === "mythicWeapons" && state.mythicWeapons <= 0){
        const idx = findStepIndex("mythicWeaponsMax");
        if (idx !== -1) return showStep(idx + 1);
      }
      if (id === "mythicOperators" && state.mythicOperators <= 0){
        const idx = findStepIndex("mythicOperatorsMax");
        if (idx !== -1) return showStep(idx + 1);
      }
      if (id === "hasRareLegendaryOperators" && !state.hasRareLegendaryOperators){
        const idx = findStepIndex("rareLegendaryOperators");
        if (idx !== -1) return showStep(idx + 1);
      }
      if (id === "seasonalRank"){
        const sumIdx = findStepIndex("summary");
        if (sumIdx !== -1){
          const sumEl = stepEls[sumIdx];
          if (sumEl && sumEl.refreshSummary) sumEl.refreshSummary();
          return showStep(sumIdx);
        }
      }
      _next();
    };

    const _prev = prevStep;
    prevStep = function(){
      const id = stepEls[currentStepIndex]?.dataset?.stepId;

      if (id === "legendaryWeapons" && state.mythicWeapons <= 0){
        const mythIdx = findStepIndex("mythicWeapons");
        if (mythIdx !== -1) return showStep(mythIdx);
      }
      if (id === "legendaryOperators" && state.mythicOperators <= 0){
        const mythOpIdx = findStepIndex("mythicOperators");
        if (mythOpIdx !== -1) return showStep(mythOpIdx);
      }
      if (id === "accountLevel" && !state.hasRareLegendaryOperators){
        const ynIdx = findStepIndex("hasRareLegendaryOperators");
        if (ynIdx !== -1) return showStep(ynIdx);
      }
      _prev();
    };

    // אם המשתמש בחר “המשך לחשבון שלי” מהמודאל של חלק 1
    // אחרי הבנייה המלאה – ננסה להביא אותו לסיכום אוטומטית אם יש נתונים
    setTimeout(() => {
      const saved = loadFromStorage();
      if (!saved || !saved.state) return;
      const hasAny = !!saved.state.accountType || (saved.state.cpAmount && saved.state.cpAmount !== 0);
      if (!hasAny) return;

      // אם כבר התחילו (welcome מוסתר) אז נוכל לקפוץ
      if (welcome.style.display === "none"){
        const sumIdx = findStepIndex("summary");
        if (sumIdx !== -1){
          const sumEl = stepEls[sumIdx];
          if (sumEl && sumEl.refreshSummary) sumEl.refreshSummary();
        }
      }
    }, 200);

  </script>
</body>
</html>
